<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Obligacji Skarbu Państwa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <script>
        pdfMake.fonts = {
            Roboto: {
                normal: 'https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2',
                bold: 'https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBBc4AMP6lQ.woff2',
                italics: 'https://fonts.gstatic.com/s/roboto/v30/KFOkCnqEu92Fr1Mu51xIIzIXKMny.woff2',
                bolditalics: 'https://fonts.gstatic.com/s/roboto/v30/KFOjCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2'
            }
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<style>
    body {
        background-color: #f5f6f5;
        font-family: 'Montserrat', sans-serif;
        padding: 10px;
    }
    .logo-container {
        background-color: #e9ecef;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .logo {
        max-width: 200px;
        margin-bottom: 0;
        cursor: pointer;
    }
    .zoom-controls {
        display: flex;
        gap: 10px;
    }
    .zoom-controls button {
        width: 30px;
        height: 30px;
        font-size: 18px;
        line-height: 30px;
        text-align: center;
        background: linear-gradient(135deg, #C2B280, #b0a070);
        border: none;
        border-radius: 5px;
        color: #000000;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.3s ease;
    }
    .zoom-controls button:hover {
        transform: scale(1.1);
        background: linear-gradient(135deg, #b0a070, #C2B280);
    }
    .zoom-controls button:active {
        transform: scale(0.95);
    }
    .container {
        max-width: 1200px;
        margin: 30px auto 0;
        background: #FFFFFF;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .header-row {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
        position: relative;
    }
    .header-row h4 {
        font-size: 1.2em;
        color: #333333;
        font-weight: 700;
        margin: 0;
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        font-size: 0.7em;
        color: #333333;
        cursor: pointer;
    }
    .checkbox-label input {
        display: none;
    }
    .checkbox-custom {
        width: 16px;
        height: 16px;
        border: 2px solid #C2B280;
        background-color: #fff;
        margin-right: 5px;
        display: inline-block;
        position: relative;
    }
    .checkbox-label input:checked + .checkbox-custom {
        background-color: #C2B280;
    }
    .checkbox-label input:checked + .checkbox-custom::after {
        content: '✔';
        color: #000;
        font-size: 12px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .checkbox-label.header-checkbox {
        position: absolute;
        top: 0;
        right: 10px;
    }
</style>
<div class="logo-container">
    <a href="https://finance-brothers.pl">
        <img src="https://finance-brothers.pl/wp-content/uploads/2023/10/cropped-logo-FB-1.png" alt="Finance Brothers Logo" class="logo d-block">
    </a>
    <div class="zoom-controls">
        <button id="zoom-in">+</button>
        <button id="zoom-out">-</button>
    </div>
</div>
<div class="container">
    <div class="header-row">
        <h4>Kalkulator Obligacji Skarbu Państwa</h4>
        <label class="checkbox-label header-checkbox">
            <input type="checkbox" id="ikeIkzeMode">
            <span class="checkbox-custom"></span>
            IKE/IKZE
        </label>
    </div>
        <div class="form-section" id="formSection">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Kwota inwestycji</label>
                <input type="number" class="form-control" id="kwota" min="100" step="100" value="1000">
                <div class="sub-info">Minimum: 100 zł</div>
            </div>
            <div class="form-group">
                <label class="form-label">Typ obligacji</label>
                <select class="form-select" id="typObligacji">
                    <option value="OTS">OTS (3 miesiące)</option>
                    <option value="ROR">ROR (1 rok)</option>
                    <option value="DOR">DOR (2 lata)</option>
                    <option value="TOS">TOS (3 lata)</option>
                    <option value="COI">COI (4 lata)</option>
                    <option value="EDO">EDO (10 lat)</option>
                    <option value="ROS">ROS (6 lat)</option>
                    <option value="ROD">ROD (12 lat)</option>
                </select>
            </div>
            <div class="form-group" id="dynamicRateContainer">
                <label class="form-label" id="dynamicRateLabel">Inflacja</label>
                <input type="number" class="form-control" id="dynamicRate" min="0" step="0.1" value="4.9">
                <div class="sub-info">%</div>
            </div>
        </div>
        <div class="form-row" id="variableRateContainer" style="display: none;">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="inflacjaZmiennaBtn">
                    <span class="checkbox-custom"></span>
                    Zmienna inflacja/stopa
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">Cykl zmiany</label>
                <input type="number" class="form-control" id="variableCycle" min="2" step="1" value="2">
            </div>
            <div class="form-group">
                <label class="form-label">Nowa wartość</label>
                <input type="number" class="form-control" id="variableValue" min="0" step="0.1" value="4.9">
                <div class="sub-info">%</div>
            </div>
            <div class="form-group">
                <button class="btn btn-sm" id="addVariableRateBtn" style="margin-top: 20px;">Dodaj</button>
            </div>
        </div>
        <div id="variableRatesList"></div>
        <div class="opis-container">
            <button class="btn-calculate" id="calculateBtn">Oblicz</button>
            <div class="obligacje-opis" id="obligacjeOpis"></div>
        </div>
        <div class="data-container">
            <span class="data-info">Dane z dnia:</span>
            <span class="data-date">01.03.2025r.</span>
        </div>
    </div>
        <div class="result-section" id="resultSection">
        <div class="result-header">
            <h4 id="resultHeader">Wynik inwestycji</h4>
            <button class="btn-return" id="returnBtn">Powrót</button>
            <button class="btn-pdf" id="generatePdfBtn">Generuj PDF</button>
        </div>
        <div class="result-wrapper-chart">
            <div class="chart-container">
                <canvas id="obligacjeChart" class="chart"></canvas>
            </div>
            <div class="legend-container">
                <div class="legend-item" data-index="0">
                    <span class="color-box" style="background-color: #28a745;" data-tooltip="Kapitał"></span>
                    <span>Kapitał:</span>
                    <span id="valueKapital">0,00 zł</span>
                </div>
                <div class="legend-item" data-index="1">
                    <span class="color-box" style="background-color: #007bff;" data-tooltip="Odsetki"></span>
                    <span>Odsetki:</span>
                    <span id="valueOdsetki">0,00 zł</span>
                </div>
                <div class="legend-item" data-index="2">
                    <span class="color-box" style="background-color: #dc3545;" data-tooltip="Podatek"></span>
                    <span>Podatek:</span>
                    <span id="valuePodatek">0,00 zł</span>
                </div>
                <div class="legend-item">
                    <span>Okres inwestycji:</span>
                    <span id="okresInwestycji" class="highlight yellow" data-hover="0 miesięcy">0 miesięcy</span>
                </div>
                <div class="legend-item">
                    <span>Zysk netto:</span>
                    <span id="zyskNetto" class="highlight green" data-hover="0,00 zł">0,00 zł</span>
                </div>
            </div>
        </div>
        <div class="harmonogram-container">
            <h5>Harmonogram odsetek</h5>
            <table class="harmonogram-table">
                <thead>
                    <tr>
                        <th id="pierwszaKolumnaNaglowek">Rok</th>
                        <th>Wartość inwestycji</th>
                        <th>Oproc.</th>
                        <th>Odsetki</th>
                        <th>Suma odsetek</th>
                        <th>Podatek</th>
                        <th id="zyskKolumnaNaglowek">Zysk netto</th>
                        <th>Opłata za wykup</th>
                        <th id="kolumnaStopaInflacja">Inflacja</th>
                        <th>Suma netto</th>
                    </tr>
                </thead>
                <tbody id="harmonogramTabela"></tbody>
            </table>
            <div class="harmonogram-opis" id="harmonogramOpis"></div>
        </div>
        <div class="chart-line-container">
            <canvas id="obligacjeChartLine" class="obligacje-chart-line"></canvas>
        </div>
    </div>
</div>
<style>
    .form-section { padding: 10px; position: relative; }
    .form-row { display: flex; justify-content: center; margin-bottom: 10px; gap: 10px; align-items: flex-start; }
    .form-group { flex: 1; min-width: 0; max-width: 150px; }
    .form-label { font-size: 0.7em; text-transform: uppercase; margin-bottom: 2px; color: #333333; }
    .form-control, .form-select, .form-range { height: 22px; font-size: 0.7em; padding: 2px; text-align: center; }
    .form-select { max-width: 100px; appearance: none; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQ0lEQVR42mNgwAfKy8Q/Y//+Ii//3jVAYQzsIFyQ0dOaWq992zxcnN5+9NmyZACV40DmGhPZtzwUAxhUaoLntdha0DqQbtz4E9DzN6XgI0P2VYFlQrUwoQDIgbChLE/0awXiwV5rhugPX6A8BSsYFDqU+rEFdkGZA7+G9HMqaAU6l+0w+NdJD7ADhzhR/4KDZnWOw0QKrVqYc1G+1Dczfx8DR0uv+QJqDRvQxdizFAQAwsy39EZhAAAwAAJ4+Q1XFlAAAAABJRU5ErkJggg==') no-repeat right 5px center; }
    .form-range { margin-top: 2px; height: 8px; background: #d3d3d3; border-radius: 5px; }
    .form-range::-webkit-slider-thumb { background: #C2B280; border: none; border-radius: 50%; width: 12px; height: 12px; cursor: pointer; -webkit-appearance: none; }
    .form-range::-moz-range-thumb { background: #C2B280; border: none; border-radius: 50%; width: 12px; height: 12px; cursor: pointer; }
    .input-group-text { font-size: 0.7em; padding: 2px 5px; }
    .sub-info { font-size: 0.4em; color: #333333; margin-top: 2px; text-align: left; }
    .opis-container { margin-top: 20px; text-align: center; margin-bottom: 10px; }
    .obligacje-opis, .harmonogram-opis { font-size: 0.6em; color: #333333; text-align: center; max-width: 400px; margin: 10px auto 0; line-height: 1.4; }
    .data-container { text-align: right; margin-top: 5px; }
    .data-info { font-size: 0.8em; color: #C2B280; }
    .data-date { font-size: 0.8em; }
    .btn-calculate { background: linear-gradient(135deg, #C2B280, #b0a070); border: none; padding: 8px 20px; font-size: 0.9em; border-radius: 5px; color: #000000; transition: transform 0.2s ease, background 0.3s ease; }
    .btn-calculate:hover { transform: scale(1.05); background: linear-gradient(135deg, #b0a070, #C2B280); }
    .btn-calculate:active { transform: scale(0.95); }
    .result-section { display: none; padding: 10px; max-width: 1200px; margin: 0 auto; background: #FFFFFF; }
    .result-header { text-align: center; margin-bottom: 20px; position: relative; }
    .result-header h4 { font-size: 1.2em; color: #333333; font-weight: 700; display: inline-block; }
    .btn-return, .btn-pdf { position: absolute; top: 0; padding: 5px 15px; font-size: 0.8em; border-radius: 5px; }
    .btn-return { left: 10px; background: #6c757d; color: #fff; }
    .btn-pdf { right: 10px; background: linear-gradient(135deg, #C2B280, #b0a070); color: #000; }
    .result-wrapper-chart { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; margin: 20px auto; }
    .chart-container { width: 100%; max-width: 400px; margin: 0 auto; }
    .chart { width: 120px; height: 120px; }
    .legend-container { text-align: left; margin-top: 10px; }
    .legend-item { font-size: 0.8em; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
    .color-box { width: 12px; height: 12px; display: inline-block; position: relative; }
    .color-box:hover:after { content: attr(data-tooltip); position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 2px 5px; font-size: 0.7em; border-radius: 3px; white-space: nowrap; }
    .highlight { font-weight: bold; }
    .highlight.yellow { color: #C2B280; }
    .highlight.green { color: #28a745; }
    .highlight[data-hover]:hover:after { content: attr(data-hover); position: absolute; background: #333; color: #fff; padding: 2px 5px; font-size: 0.7em; border-radius: 3px; white-space: nowrap; margin-left: 5px; }
    .harmonogram-container { margin-top: 20px; text-align: center; }
    .harmonogram-container h5 { font-size: 1em; margin-bottom: 10px; }
    .harmonogram-table { width: 100%; border-collapse: collapse; font-size: 0.7em; margin: 0 auto; }
    .harmonogram-table th, .harmonogram-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
    .harmonogram-table th { background-color: #C2B280; color: #000; }
    .harmonogram-table tr:nth-child(even) { background-color: #f9f9f9; }
    .chart-line-container { margin-top: 20px; }
    .obligacje-chart-line { width: 100%; height: 300px; }
</style>
<script>
    const elements = {
        formSection: document.getElementById("formSection"),
        resultSection: document.getElementById("resultSection"),
        kwota: document.getElementById("kwota"),
        typObligacji: document.getElementById("typObligacji"),
        dynamicRate: document.getElementById("dynamicRate"),
        dynamicRateLabel: document.getElementById("dynamicRateLabel"),
        dynamicRateContainer: document.getElementById("dynamicRateContainer"),
        variableRateContainer: document.getElementById("variableRateContainer"),
        inflacjaZmiennaBtn: document.getElementById("inflacjaZmiennaBtn"),
        stopaZmiennaBtn: document.getElementById("stopaZmiennaBtn"),
        variableCycle: document.getElementById("variableCycle"),
        variableValue: document.getElementById("variableValue"),
        addVariableRateBtn: document.getElementById("addVariableRateBtn"),
        variableRatesList: document.getElementById("variableRatesList"),
        calculateBtn: document.getElementById("calculateBtn"),
        returnBtn: document.getElementById("returnBtn"),
        generatePdfBtn: document.getElementById("generatePdfBtn"),
        resultHeader: document.getElementById("resultHeader"),
        obligacjeChart: document.getElementById("obligacjeChart"),
        obligacjeChartLine: document.getElementById("obligacjeChartLine"),
        harmonogramTabela: document.getElementById("harmonogramTabela"),
        harmonogramOpis: document.getElementById("harmonogramOpis"),
        obligacjeOpis: document.getElementById("obligacjeOpis"),
        ikeIkzeMode: document.getElementById("ikeIkzeMode"),
        zoomInBtn: document.getElementById("zoom-in"),
        zoomOutBtn: document.getElementById("zoom-out")
    };

    const state = {
        isCalculating: false,
        chart: null,
        chartLine: null,
        harmonogramData: [],
        isIkeIkzeMode: false,
        variableInflacjaChanges: [],
        variableStopaChanges: [],
        lastFormData: {
            kwota: 1000,
            typObligacji: "OTS",
            dynamicRates: { OTS: 5.75, ROR: 5.75, DOR: 5.75, TOS: 5.75, COI: 4.9, EDO: 4.9, ROS: 4.9, ROD: 4.9 },
            okres: 3,
            oprocentowanie: 5.75,
            ikeIkze: false,
            inflacjaZmienna: false,
            stopaZmienna: false,
            variableInflacjaChanges: [],
            variableStopaChanges: []
        }
    };

    const obligacjeConfig = {
        OTS: { okres: 3, oprocentowanie: 5.75, marza: 0, kapitalizacja: false, oplataWykup: 0.007 },
        ROR: { okres: 12, oprocentowanie: 5.75, marza: 0.25, kapitalizacja: false, oplataWykup: 0.007 },
        DOR: { okres: 24, oprocentowanie: 5.75, marza: 0.50, kapitalizacja: false, oplataWykup: 0.007 },
        TOS: { okres: 36, oprocentowanie: 5.85, marza: 0, kapitalizacja: false, oplataWykup: 0.007 },
        COI: { okres: 48, oprocentowanie: 6.85, marza: 0.75, kapitalizacja: true, oplataWykup: 0.015 },
        EDO: { okres: 120, oprocentowanie: 7.0, marza: 1.25, kapitalizacja: true, oplataWykup: 0.020 },
        ROS: { okres: 72, oprocentowanie: 6.95, marza: 1.0, kapitalizacja: false, oplataWykup: 0.015 },
        ROD: { okres: 144, oprocentowanie: 7.05, marza: 1.5, kapitalizacja: false, oplataWykup: 0.020 }
    };

    const nazwyObligacji = {
        OTS: "3-miesięczne OTS",
        ROR: "roczne ROR",
        DOR: "2-letnie DOR",
        TOS: "3-letnie TOS",
        COI: "4-letnie COI",
        EDO: "10-letnie EDO",
        ROS: "6-letnie ROS",
        ROD: "12-letnie ROD"
    };

    elements.typObligacji.addEventListener("change", updateDynamicRateField);
    elements.calculateBtn.addEventListener("click", obliczObligacje);
    elements.returnBtn.addEventListener("click", () => {
        elements.resultSection.style.display = "none";
        elements.formSection.style.display = "block";
    });
    elements.generatePdfBtn.addEventListener("click", generatePdf);
    elements.ikeIkzeMode.addEventListener("change", () => {
        state.isIkeIkzeMode = elements.ikeIkzeMode.checked;
    });
    elements.addVariableRateBtn.addEventListener("click", addVariableRate);

    function updateDynamicRateField() {
        const typ = elements.typObligacji.value;
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        elements.dynamicRateLabel.textContent = isInflacja ? "Inflacja" : "Stopa Ref. NBP";
        elements.dynamicRate.value = state.lastFormData.dynamicRates[typ];
        elements.variableRateContainer.style.display = ["ROR", "DOR", "COI", "EDO", "ROS", "ROD"].includes(typ) ? "flex" : "none";
        elements.inflacjaZmiennaBtn.checked = false;
        elements.stopaZmiennaBtn.checked = false;
        updateVariableRatesList();
    }

    function addVariableRate() {
        const typ = elements.typObligacji.value;
        const cykl = parseInt(elements.variableCycle.value);
        const wartosc = parseFloat(elements.variableValue.value);
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const changes = isInflacja ? state.variableInflacjaChanges : state.variableStopaChanges;

        if (cykl >= 2 && wartosc >= 0) {
            changes.push({ cykl, wartosc });
            updateVariableRatesList();
        }
    }

    function updateVariableRatesList() {
        const typ = elements.typObligacji.value;
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const changes = isInflacja ? state.variableInflacjaChanges : state.variableStopaChanges;
        elements.variableRatesList.innerHTML = changes.map((change, index) => 
            `<div>Cykl ${change.cykl}: ${change.wartosc}% <button onclick="removeVariableRate(${index}, '${isInflacja ? 'inflacja' : 'stopa'}')">Usuń</button></div>`
        ).join("");
    }

    function removeVariableRate(index, type) {
        if (type === "inflacja") state.variableInflacjaChanges.splice(index, 1);
        else state.variableStopaChanges.splice(index, 1);
        updateVariableRatesList();
    }

    let currentScale = 1;
    const minScale = 0.5;
    const maxScale = 2;
    const scaleStep = 0.1;

    elements.zoomInBtn.addEventListener("click", () => {
        if (currentScale < maxScale) {
            currentScale = Math.min(maxScale, currentScale + scaleStep);
            document.body.style.zoom = currentScale;
        }
    });

    elements.zoomOutBtn.addEventListener("click", () => {
        if (currentScale > minScale) {
            currentScale = Math.max(minScale, currentScale - scaleStep);
            document.body.style.zoom = currentScale;
        }
    });

    function obliczObligacje() {
        if (state.isCalculating) return;
        state.isCalculating = true;

        if (typeof Chart === "undefined") {
            alert("Błąd: Nie można załadować wykresów.");
            state.isCalculating = false;
            return;
        }

        const kwota = parseFloat(elements.kwota.value) || 0;
        const typ = elements.typObligacji.value;
        const config = obligacjeConfig[typ];
        const miesiace = config.okres;
        const dynamicRate = parseFloat(elements.dynamicRate.value) || state.lastFormData.dynamicRates[typ];
        const inflacja = (["COI", "EDO", "ROS", "ROD"].includes(typ) ? dynamicRate : 4.90) / 100;
        const stopaRefNBP = (["ROR", "DOR"].includes(typ) ? dynamicRate : 5.75) / 100;
        const isInflacja = ["COI", "EDO", "ROS", "ROD"].includes(typ);
        const inflacjaZmienna = elements.inflacjaZmiennaBtn.checked && isInflacja;
        const stopaZmienna = elements.stopaZmiennaBtn.checked && ["ROR", "DOR"].includes(typ);
        const podatekBelki = state.isIkeIkzeMode ? 0 : 0.19;

        state.lastFormData = {
            kwota, typObligacji: typ, dynamicRates: { ...state.lastFormData.dynamicRates, [typ]: dynamicRate },
            okres: miesiace, oprocentowanie: config.oprocentowanie, ikeIkze: state.isIkeIkzeMode,
            inflacjaZmienna, stopaZmienna, variableInflacjaChanges: [...state.variableInflacjaChanges],
            variableStopaChanges: [...state.variableStopaChanges]
        };

        if (kwota < 100 || miesiace <= 0) {
            alert("Proszę wypełnić wszystkie pola poprawnymi wartościami.");
            state.isCalculating = false;
            return;
        }

        elements.resultHeader.textContent = `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}*`;
        document.getElementById("pierwszaKolumnaNaglowek").textContent = ["OTS", "ROR", "DOR"].includes(typ) ? "Miesiąc" : "Rok";
        document.getElementById("kolumnaStopaInflacja").textContent = ["ROR", "DOR"].includes(typ) ? "Stopa Ref. NBP" : "Inflacja";
        document.getElementById("kolumnaStopaInflacja").style.display = ["OTS", "TOS"].includes(typ) ? "none" : "table-cell";
        document.getElementById("zyskKolumnaNaglowek").textContent = state.isIkeIkzeMode ? "Zysk" : "Zysk netto";

        let kapital = kwota;
        let odsetkiCalkowite = 0;
        let zyskNettoCalkowity = 0;
        state.harmonogramData = [];
        let skumulowaneOdsetki = 0;

        let liczbaCykli = ["OTS", "ROR", "DOR"].includes(typ) ? miesiace : miesiace / 12;
        let changes = inflacjaZmienna ? state.variableInflacjaChanges : (stopaZmienna ? state.variableStopaChanges : []);
        changes.sort((a, b) => a.cykl - b.cykl);

        for (let i = 1; i <= liczbaCykli; i++) {
            let changeApplied = false;
            let stopaRefLubInflacja = "-";
            let oprocentowanieRoczne;

            if (inflacjaZmienna || stopaZmienna) {
                let dynamicValue = (inflacjaZmienna ? 4.90 : 5.75) / 100;
                for (const change of changes) {
                    if (i >= change.cykl) {
                        dynamicValue = change.wartosc / 100;
                        if (i === change.cykl) changeApplied = true;
                    }
                }
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (dynamicValue + config.marza / 100);
                stopaRefLubInflacja = (dynamicValue * 100).toFixed(2) + "%";
            } else if (isInflacja) {
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (inflacja + config.marza / 100);
                stopaRefLubInflacja = (inflacja * 100).toFixed(2) + "%";
            } else if (["ROR", "DOR"].includes(typ)) {
                oprocentowanieRoczne = i === 1 ? config.oprocentowanie / 100 : (stopaRefNBP + config.marza / 100);
                stopaRefLubInflacja = (stopaRefNBP * 100).toFixed(2) + "%";
            } else {
                oprocentowanieRoczne = config.oprocentowanie / 100;
            }

            let oprocentowanieMiesieczne = oprocentowanieRoczne / 12;
            let miesiecyWCyklu = ["OTS", "ROR", "DOR"].includes(typ) ? 1 : 12;
            let odsetkiCykl = kapital * oprocentowanieMiesieczne * miesiecyWCyklu;

            let podatekCykl = odsetkiCykl * podatekBelki;
            let odsetkiNettoCykl = state.isIkeIkzeMode ? odsetkiCykl : (odsetkiCykl - podatekCykl);

            odsetkiCalkowite += odsetkiCykl;
            skumulowaneOdsetki += odsetkiCykl;
            zyskNettoCalkowity += odsetkiNettoCykl;

            let wartoscInwestycji = kwota;
            if (config.kapitalizacja) {
                kapital += odsetkiCykl;
                wartoscInwestycji = kapital;
            }

            let kwotaPoCyklu = state.isIkeIkzeMode ? (config.kapitalizacja ? wartoscInwestycji : kwota + zyskNettoCalkowity) :
                (config.kapitalizacja ? (wartoscInwestycji - skumulowaneOdsetki * 0.19) : kwota + zyskNettoCalkowity);

            let oplataZaWykup = i < liczbaCykli ? kwota * config.oplataWykup : 0;

            state.harmonogramData.push({
                okres: i, wartoscInwestycji: wartoscInwestycji.toFixed(2), oprocentowanieNaCykl: (oprocentowanieRoczne * 100).toFixed(2) + "%",
                odsetkiBrutto: odsetkiCykl.toFixed(2), skumulowaneOdsetki: skumulowaneOdsetki.toFixed(2), podatek: podatekCykl.toFixed(2),
                zyskNetto: odsetkiNettoCykl.toFixed(2), oplataZaWykup: oplataZaWykup.toFixed(2), stopaRefLubInflacja, kwotaPoZakonczeniuCyklu: kwotaPoCyklu.toFixed(2),
                changeApplied
            });
        }

        document.getElementById("valueKapital").textContent = `${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.legend-item[data-index="0"] .color-box').setAttribute('data-tooltip', `Kapitał: ${kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);

        document.getElementById("valueOdsetki").textContent = `${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.legend-item[data-index="1"] .color-box').setAttribute('data-tooltip', `Odsetki: ${odsetkiCalkowite.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);

        const podatekCalkowity = odsetkiCalkowite * (state.isIkeIkzeMode ? 0 : 0.19);
        document.getElementById("valuePodatek").textContent = state.isIkeIkzeMode ? "0,00 zł***" : `${podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.legend-item[data-index="2"] .color-box').setAttribute('data-tooltip', `Podatek: ${state.isIkeIkzeMode ? "0,00 zł***" : podatekCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 }) + " zł"}`);

        const jednostkaOkresu = ["OTS", "DOR", "ROS", "ROD"].includes(typ) ? "miesiące" : "miesięcy";
        document.getElementById("okresInwestycji").textContent = `${miesiace} ${jednostkaOkresu}`;
        document.querySelector('.highlight.yellow').setAttribute('data-hover', `${miesiace} ${jednostkaOkresu}`);

        document.getElementById("zyskNetto").textContent = `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`;
        document.querySelector('.highlight.green').setAttribute('data-hover', `${zyskNettoCalkowity.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`);

        if (state.chart) state.chart.destroy();
        if (state.chartLine) state.chartLine.destroy();

        state.chart = new Chart(elements.obligacjeChart.getContext("2d"), {
            type: 'doughnut',
            data: {
                labels: ['Kapitał', 'Odsetki', 'Podatek'],
                datasets: [{ data: [kwota, odsetkiCalkowite, state.isIkeIkzeMode ? 0 : podatekCalkowity], backgroundColor: ['#28a745', '#007bff', '#dc3545'], borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: true, plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (item) => `${item.label}: ${item.raw.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł` } }
                },
                cutout: '50%'
            }
        });

        elements.harmonogramTabela.innerHTML = "";
        state.harmonogramData.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.okres}${row.changeApplied ? "*" : ""}</td>
                <td>${row.wartoscInwestycji} zł</td>
                <td>${row.oprocentowanieNaCykl}</td>
                <td>${row.odsetkiBrutto} zł</td>
                <td>${row.skumulowaneOdsetki} zł</td>
                <td>${row.podatek} zł</td>
                <td>${row.zyskNetto} zł</td>
                <td>${row.oplataZaWykup} zł</td>
                <td style="display: ${["OTS", "TOS"].includes(typ) ? 'none' : 'table-cell'}">${row.stopaRefLubInflacja}</td>
                <td>${row.kwotaPoZakonczeniuCyklu} zł</td>
            `;
            elements.harmonogramTabela.appendChild(tr);
        });

        elements.harmonogramOpis.innerHTML = state.isIkeIkzeMode ?
            "***Zwolnienie z podatku Belki w ramach IKE/IKZE pod warunkiem spełnienia wymogów ustawowych." :
            "*Podane wartości mogą się różnić w zależności od rzeczywistej stopy referencyjnej NBP lub inflacji.";

        state.chartLine = new Chart(elements.obligacjeChartLine.getContext("2d"), {
            type: 'line',
            data: {
                labels: state.harmonogramData.map(row => row.okres),
                datasets: [{
                    label: 'Wartość inwestycji',
                    data: state.harmonogramData.map(row => parseFloat(row.kwotaPoZakonczeniuCyklu)),
                    borderColor: '#C2B280',
                    backgroundColor: 'rgba(194, 178, 128, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: ["OTS", "ROR", "DOR"].includes(typ) ? "Miesiąc" : "Rok" } },
                    y: { title: { display: true, text: 'Wartość (zł)' }, beginAtZero: false }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (item) => `Wartość: ${item.raw.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł` } }
                }
            }
        });

        elements.formSection.style.display = "none";
        elements.resultSection.style.display = "block";
        state.isCalculating = false;
    }

    function generatePdf() {
        const typ = elements.typObligacji.value;
        const config = obligacjeConfig[typ];
        const jednostkaOkresu = ["OTS", "DOR", "ROS", "ROD"].includes(typ) ? "miesiące" : "miesięcy";

        const docDefinition = {
            pageSize: 'A4',
            pageMargins: [40, 60, 40, 60],
            header: { image: 'https://finance-brothers.pl/wp-content/uploads/2023/10/cropped-logo-FB-1.png', width: 150, alignment: 'center', margin: [0, 20, 0, 0] },
            footer: (currentPage, pageCount) => ({ text: `Strona ${currentPage} z ${pageCount}`, alignment: 'center', fontSize: 8, margin: [0, 30, 0, 0] }),
            content: [
                { text: `Wynik inwestycji dla obligacji ${nazwyObligacji[typ]}${state.isIkeIkzeMode ? " (IKE/IKZE)" : ""}`, style: 'header', margin: [0, 20, 0, 10] },
                { text: `Kwota inwestycji: ${state.lastFormData.kwota.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`, style: 'subheader' },
                { text: `Okres inwestycji: ${state.lastFormData.okres} ${jednostkaOkresu}`, style: 'subheader' },
                { text: `Zysk netto: ${parseFloat(document.getElementById("zyskNetto").textContent.replace(/\s/g, '').replace('zł', '').replace(',', '.')).toLocaleString('pl-PL', { minimumFractionDigits: 2 })} zł`, style: 'subheader' },
                { text: 'Harmonogram odsetek', style: 'subheader', margin: [0, 20, 0, 10] },
                {
                    table: {
                        headerRows: 1,
                        widths: ['auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
                        body: [
                            [
                                { text: ["OTS", "ROR", "DOR"].includes(typ) ? "Miesiąc" : "Rok", style: 'tableHeader' },
                                { text: 'Wartość inwestycji', style: 'tableHeader' },
                                { text: 'Oproc.', style: 'tableHeader' },
                                { text: 'Odsetki', style: 'tableHeader' },
                                { text: 'Suma odsetek', style: 'tableHeader' },
                                { text: 'Podatek', style: 'tableHeader' },
                                { text: state.isIkeIkzeMode ? 'Zysk' : 'Zysk netto', style: 'tableHeader' },
                                { text: 'Opłata za wykup', style: 'tableHeader' },
                                { text: ["ROR", "DOR"].includes(typ) ? 'Stopa Ref. NBP' : 'Inflacja', style: 'tableHeader', colSpan: ["OTS", "TOS"].includes(typ) ? 0 : 1 },
                                { text: 'Suma netto', style: 'tableHeader' }
                            ],
                            ...state.harmonogramData.map(row => [
                                `${row.okres}${row.changeApplied ? "*" : ""}`,
                                `${row.wartoscInwestycji} zł`,
                                row.oprocentowanieNaCykl,
                                `${row.odsetkiBrutto} zł`,
                                `${row.skumulowaneOdsetki} zł`,
                                `${row.podatek} zł`,
                                `${row.zyskNetto} zł`,
                                `${row.oplataZaWykup} zł`,
                                ["OTS", "TOS"].includes(typ) ? '' : row.stopaRefLubInflacja,
                                `${row.kwotaPoZakonczeniuCyklu} zł`
                            ])
                        ]
                    },
                    layout: { fillColor: (rowIndex) => (rowIndex % 2 === 0 ? '#f9f9f9' : null), hLineWidth: () => 0.5, vLineWidth: () => 0.5 }
                },
                { text: state.isIkeIkzeMode ? '***Zwolnienie z podatku Belki w ramach IKE/IKZE pod warunkiem spełnienia wymogów ustawowych.' : '*Podane wartości mogą się różnić w zależności od rzeczywistej stopy referencyjnej NBP lub inflacji.', style: 'footerNote', margin: [0, 10, 0, 0] },
                { text: 'Dane z dnia: 01.03.2025r.', style: 'footerNote', alignment: 'right' }
            ],
            styles: {
                header: { fontSize: 18, bold: true, alignment: 'center' },
                subheader: { fontSize: 12, bold: true, margin: [0, 5, 0, 0] },
                tableHeader: { fontSize: 10, bold: true, fillColor: '#C2B280', color: '#000000', alignment: 'center' },
                footerNote: { fontSize: 8, italics: true }
            },
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };

        pdfMake.createPdf(docDefinition).download(`Wynik_inwestycji_${typ}_${new Date().toLocaleDateString('pl-PL')}.pdf`);
    }
</script>
</body>
</html>
